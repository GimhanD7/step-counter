<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Step Count with Fall Detection</title>
    <link rel="stylesheet" href="styles.css">

   <script type="module">
    // Import the Firebase modules you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js";
    import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-database.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyAEzNVVk26Gm5izWVfRaX1gbrbPzvjK8-g",
        authDomain: "iot-project-sliit.firebaseapp.com",
        databaseURL: "https://iot-project-sliit-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "iot-project-sliit",
        storageBucket: "iot-project-sliit.appspot.com",
        messagingSenderId: "639036929970",
        appId: "1:639036929970:web:d55b3a6e56e64fa64ed6ab"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // References for step count, goal, weight, and fall detection
    const stepCountRef = ref(database, 'stepCount');
    const goalRef = ref(database, 'goal');
    const weightRef = ref(database, 'weight');  // Reference to store user's weight
    const fallDetectedRef = ref(database, 'fallDetected');  // Reference for fall detection status

    // Fetch and display step count and update calories burned and progress
    let stepCount = 0;
    let userWeight = 70;  // Default weight

    // Show loader until data is loaded
    window.addEventListener('load', () => {
        setTimeout(() => {
            const loader = document.getElementById('loader');
            const content = document.getElementById('content');

            // Hide the loader and show the content after the page is fully loaded
            loader.style.display = 'none';
            content.style.display = 'block';
        }, 2000);  // Simulate 2 seconds of loading time
    });

    onValue(stepCountRef, (snapshot) => {
        stepCount = snapshot.val();
        document.getElementById('stepCount').innerText = stepCount;
        updateCalories(stepCount);
        updateProgress(stepCount);
    });

// Fetch fall detection status and trigger notification
onValue(fallDetectedRef, (snapshot) => {
            const fallDetected = snapshot.val();
            const fallStatusElement = document.getElementById('fallStatus');
            
            if (fallDetected) {
                fallStatusElement.innerText = "Fall Detected!";
                fallStatusElement.style.color = "red";

                // Trigger browser notification if a fall is detected
                if (Notification.permission === "granted") {
                    new Notification("Fall Detected!", {
                        body: "A fall has been detected. Please check your device for more information.",
                        icon: 'fall_icon.png'  // Add an icon if you have one
                    });
                }

                // Revert fall detection status after 5 seconds
                setTimeout(() => {
                    fallStatusElement.innerText = "No Falls Detected";
                    fallStatusElement.style.color = "green";
                }, 5000);
            } else {
                fallStatusElement.innerText = "No Falls Detected";
                fallStatusElement.style.color = "green";
            }
        });



    // Fetch weight from database
    onValue(weightRef, (snapshot) => {
        userWeight = snapshot.val() || 70;  // Use default weight of 70kg if no weight is set
        document.getElementById('weightDisplay').innerText = userWeight + ' kg';
        updateCalories(stepCount);
    });

    // Function to calculate calories burned based on MET, weight, and duration
    function updateCalories(steps) {
        const MET = 3.5;  // MET value for walking at a moderate pace
        const stepsPerMinute = 100;  // Average walking speed
        const duration = steps / stepsPerMinute / 60;  // Convert to hours
        const caloriesBurned = (MET * userWeight * duration).toFixed(2);
        const distance = (steps * 0.00078).toFixed(2);  // Average step length = 0.78m (in km)

        document.getElementById('calories').innerText = caloriesBurned;
        document.getElementById('distance').innerText = distance;
    }

    // Show name popup if no name is set
    window.addEventListener('load', () => {
        let userName = localStorage.getItem('userName');
        if (!userName) {
            document.getElementById('namePopup').style.display = 'block';
        } else {
            document.getElementById('userNameDisplay').innerText = userName;
        }
    });

    // Attach the saveName function to the window object
    window.saveName = function() {
        const name = document.getElementById('nameInput').value;
        if (name.trim()) {
            localStorage.setItem('userName', name);
            document.getElementById('userNameDisplay').innerText = name;
            document.getElementById('namePopup').style.display = 'none';
        }
    };

    // Set goal
    document.getElementById('setGoalBtn').addEventListener('click', () => {
        const goal = document.getElementById('goalInput').value;
        set(goalRef, goal);
    });

    // Set weight
    document.getElementById('setWeightBtn').addEventListener('click', () => {
        const weight = document.getElementById('weightInput').value;
        set(weightRef, weight);
    });

    // Reset all data
    window.resetData = function() {
        set(stepCountRef, 0);  // Reset step count
        set(goalRef, 10000);   // Reset goal to default (10000)
        set(weightRef, 70);    // Reset weight to default (70kg)
        set(fallDetectedRef, false); // Reset fall detection to false

        // Clear localStorage (name)
        localStorage.removeItem('userName');
        
        // Reset UI elements
        document.getElementById('stepCount').innerText = 0;
        document.getElementById('goalDisplay').innerText = 10000;
        document.getElementById('weightDisplay').innerText = '70 kg';
        document.getElementById('calories').innerText = 0;
        document.getElementById('distance').innerText = 0;
        document.getElementById('progress').style.width = '0%';
        document.getElementById('progress').innerText = '0%';
        document.getElementById('fallStatus').innerText = "No Falls Detected";
        document.getElementById('fallStatus').style.color = "green";

        // Refresh the web page after resetting the data
        location.reload();
    };

    // Update progress bar
    onValue(goalRef, (snapshot) => {
        const goal = snapshot.val();
        document.getElementById('goalDisplay').innerText = goal;
        updateProgress(stepCount, goal);
    });

    function updateProgress(steps, goal = 10000) {
        const progress = Math.min((steps / goal) * 100, 100).toFixed(2);
        document.getElementById('progress').style.width = progress + '%';
        document.getElementById('progress').innerText = progress + '%';
    }
        
    // JavaScript to display the live date and time
    function updateDateTime() {
        const dateTimeElement = document.getElementById('dateTime');
        const now = new Date();

        // Format the date and time
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const dateString = now.toLocaleDateString('en-US', options);
        const timeString = now.toLocaleTimeString('en-US', { hour12: true });

        // Update the content
        dateTimeElement.innerText = `${dateString} | ${timeString}`;
    }

    // Update the date and time every second
    setInterval(updateDateTime, 1000);
    
    window.onload = function () {
        updateDateTime(); // Initial call to display date and time on load
    };

    // Store step count history in Firebase with the current date as the key
    function saveStepHistory(steps) {
        const today = new Date();
        const formattedDate = `${today.getMonth() + 1}-${today.getDate()}-${today.getFullYear()}`; // Format as MM-DD-YYYY
        const historyRef = ref(database, `history/${formattedDate}`); // Store history by date
        set(historyRef, steps);
    }

    // Whenever step count updates, save to history
    onValue(stepCountRef, (snapshot) => {
        stepCount = snapshot.val();
        document.getElementById('stepCount').innerText = stepCount;
        updateCalories(stepCount);
        updateProgress(stepCount);
        
        // Save step count to history
        saveStepHistory(stepCount);
    });
        
</script>

</head>
<body>
<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
    <!-- Loader -->
    <div id="loader" class="loader"></div>

    <!-- Content -->
    <div id="content">
        <!-- Live Date & Time Display -->
        <div id="dateTime">Loading date and time...</div>
        <h1>Welcome, <span id="userNameDisplay">User</span></h1>

        <h2>Step Count Data</h2> 
        <p>Steps: <span id="stepCount">Loading...</span></p>
        <p>Fall Detection Status: <span id="fallStatus">No Falls Detected</span></p>
        <p>Current Weight: <span id="weightDisplay">70 kg</span></p>
        
        <!-- Weight setting -->
        <div>
            <input type="number" id="weightInput" placeholder="Enter your weight (kg)" />
            <button id="setWeightBtn">Set Weight</button>
        </div>
        
        <!-- Calories burned and distance walked table -->
        <table>
            <tr>
                <th>Calories Burned</th>
                <th>Distance (km)</th>
            </tr>
            <tr>
                <td id="calories">0</td>
                <td id="distance">0</td>
            </tr>
        </table>

        <!-- Goal setting -->
        <div>
            <input type="number" id="goalInput" placeholder="Set your step goal" />
            <button id="setGoalBtn">Set Goal</button>
        </div>

        <p>Your Goal: <span id="goalDisplay">10000</span> steps</p>

        <!-- Progress bar -->
        <div class="progress-bar">
            <div class="progress" id="progress">0%</div>
        </div>

        <!-- Reset button -->
        <button id="resetBtn" type="button" onclick="resetData()">Reset</button>
        <br>
        <button id="setHisBtn"><a href="histotry.html" class="button" >History Step Count</a></button>

    </div>
    <br>
    <!-- Footer Section -->
    <footer>
        <div>V1.0.1 &copy; 2024 GD Creations. All rights reserved.</div>
        <div>
            <a href="#privacy">Privacy Policy</a> | 
            <a href="#terms">Terms of Service</a> | 
            <a href="#contact">Contact Us</a>
        </div>
    </footer>

    <!-- Name Popup -->
    <div id="namePopup">
        <h2>Please enter your name:</h2>
        <input type="text" id="nameInput" placeholder="Enter your name" /><br>
        <button onclick="saveName()">Save Name</button>
    </div>

</body>
</html>
